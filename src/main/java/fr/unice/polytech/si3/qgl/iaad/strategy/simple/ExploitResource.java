package fr.unice.polytech.si3.qgl.iaad.strategy.simple;

import fr.unice.polytech.si3.qgl.iaad.engine.player.results.Result;
import fr.unice.polytech.si3.qgl.iaad.engine.player.actions.Decision;
import fr.unice.polytech.si3.qgl.iaad.engine.player.actions.Exploit;
import fr.unice.polytech.si3.qgl.iaad.engine.player.results.ExploitResultat;
import fr.unice.polytech.si3.qgl.iaad.strategy.Protocol;
import fr.unice.polytech.si3.qgl.iaad.strategy.common.StopExploration;
import fr.unice.polytech.si3.qgl.iaad.util.map.Compass;
import fr.unice.polytech.si3.qgl.iaad.util.map.GroundActionTile;
import fr.unice.polytech.si3.qgl.iaad.util.map.IslandMap;
import fr.unice.polytech.si3.qgl.iaad.util.resource.Resource;
import fr.unice.polytech.si3.qgl.iaad.util.resource.ResourceInformation;
import fr.unice.polytech.si3.qgl.iaad.util.workforce.Crew;

import java.awt.*;
import java.util.List;
import java.util.Map;

/**
 * @author Gaetan Vialon
 *         Created the 03/03/2017.
 */
public class ExploitResource implements Protocol {

    private Exploit action;
    private ExploitResultat exploitResult;
    private Map<Resource,Integer> contrat;
    private Crew crew;
    private IslandMap map;
    private Resource resource;

    ExploitResource(Resource resource, Map contrat, Crew crew, IslandMap map) {
        this.resource = resource;
        this.contrat = contrat;
        this.crew = crew;
        this.map = map;
        action = new Exploit(resource);
    }

    @Override
    public Decision takeDecision() {
        map.getTile(crew.getLocation()).exploitResource(resource);
        return action;
    }

    @Override
    public Protocol acknowledgeResults(Result result) {
        exploitResult = new ExploitResultat(result);
        contrat.put(resource,contrat.get(resource)-exploitResult.getExploitAmount());
        if (contrat.get(resource)<=0) {
            contrat.remove(resource);
            if (contrat.isEmpty()) return new StopExploration();
            return new MoveOnMap(choseCompass(),contrat,crew,map);
        }
        if (exploitResult.getExploitAmount() <= 2){
            if (otherResource() != null)
                return new ExploitResource(otherResource(),contrat,crew,map);
            else
                return new MoveOnMap(choseCompass(),contrat,crew,map);
        }
        return new ExploitResource(resource,contrat,crew,map);
    }


    private Resource otherResource(){
        List <ResourceInformation> info = map.getTile(crew.getLocation()).getResourceInformationList();
        for (ResourceInformation resInfo : info) {
            if (contrat.containsKey(resInfo.getResource()) && !map.getTile(crew.getLocation()).resourceAlreadyExploited(resInfo.getResource()))
                return resInfo.getResource();
        }
        return null;
    }

    private Compass choseCompass(){
        Point position = crew.getLocation();
        position.y = (int) position.getY() - 1;
        if (map.isOnMap(position) && !map.getTile(position).isAlready(GroundActionTile.VISITED))
            return Compass.N;
        else
            return Compass.S;
    }
}
